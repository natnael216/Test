<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Grade 9 Biology Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            background-color: #1e1e2d; /* Telegram-style dark */
            color: #fff;
            font-family: sans-serif;
            margin: 0;
            padding: 20px;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        ::selection { background: none; }
        html, body { height: 100%; }
        h1 {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 20px;
            color: #55acee;
            text-align: center;
        }
        p {
            white-space: pre-wrap;
            line-height: 1.6;
            margin-top: 20px;
            padding-top: 5px;
            padding-bottom: 5px;
        }
        #content-wrapper {
            max-width: 100%;
            padding: 0;
            margin: 0;
        }
        .error {
            color: #ff5555;
            text-align: center;
            font-size: 1.2rem;
        }
        #debug {
            color: #888;
            font-size: 0.9rem;
            margin-top: 20px;
            border: 1px solid #444;
            padding: 10px;
            display: none; /* Hidden by default */
        }
        @media screen {
            body:after {
                content: '';
                display: block;
                position: fixed;
                top: 0; left: 0;
                width: 100vw; height: 100vh;
                pointer-events: none;
                background: rgba(0, 0, 0, 0);
                z-index: 9999;
            }
        }
    </style>
</head>
<body>
    <div id="content-wrapper">
        <h1 id="title">Initializing...</h1>
        <p id="content">Waiting for Telegram Web App data...</p>
        <div id="debug"></div>
    </div>

    <script>
        // Replace with your actual Telegram channel username (without @)
        const ALLOWED_CHANNEL = "grade9_biology";
        const DEBUG_MODE = false; // Set to true for local testing, false for production

        // Biology lesson topics
        const topics = {
            "ab1": {
                title: "Unit 1: Introduction to Biology – 1.1 The Meaning and Importance of Biology",
                content: `Biology is the scientific study of life or living things.
ባዮሎጂ ህይወት ወይም የህይወት ያላቸው ነገሮች ሳይንሳዊ ጥናት ነው።
What does it mean to be “alive”?
"ህይወት ያለው" መሆን ማለት ምን ማለት ነው?
... (rest of the content as before)`
            },
            "ab2": {
                title: "Unit 1: Introduction to Biology – 1.2 The Methods of Studying Biology",
                content: `What is a scientific study?
(ሳይንሳዊ ጥናት ማለት ምን ማለት ነው?)
... (rest of the content as before)`
            },
            "ab3": {
                title: "Unit 1: Introduction to Biology – 1.3 The Branches of Biology",
                content: `What comes to your mind when you hear the word science?
"ሳይንስ" የሚለውን ቃል ሲሰሙ ወደ አእምሮዎ የሚመጣው ምንድን ነው?
... (rest of the content as before)`
            }
            // Add more topics here, e.g., "ab4": { title: "New Topic", content: "Content..." }
        };

        // Function to update page content
        function updateContent(topicKey, isAuthorized, debugInfo) {
            const titleElement = document.getElementById("title");
            const contentElement = document.getElementById("content");
            const debugElement = document.getElementById("debug");

            // Show debug info
            debugElement.style.display = "block";
            debugElement.textContent = `Debug Info: ${JSON.stringify(debugInfo, null, 2)}`;

            if (!isAuthorized && !DEBUG_MODE) {
                titleElement.textContent = "Access Denied";
                contentElement.innerHTML = `This content is only available via our official channel: <a href="https://t.me/${ALLOWED_CHANNEL}" style="color: #55acee;">@${ALLOWED_CHANNEL}</a>`;
                return;
            }

            const topic = topics[topicKey];
            if (topic) {
                titleElement.textContent = topic.title;
                contentElement.textContent = topic.content;
            } else {
                titleElement.textContent = "Grade 9 Biology Tutorials";
                contentElement.innerHTML = `Topic not found. Please select a valid topic from <a href="https://t.me/${ALLOWED_CHANNEL}" style="color: #55acee;">@${ALLOWED_CHANNEL}</a>.<br>Available topics:<br>` +
                    Object.keys(topics).map(key => `<a href="https://t.me/hkfdd_bot?startapp=${key}" style="color: #55acee;">${topics[key].title}</a>`).join("<br>");
            }
        }

        // Initialization
        document.addEventListener('DOMContentLoaded', () => {
            let topicKey = null;
            let isAuthorized = false;
            let debugInfo = { message: "No Telegram WebApp data available" };

            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.ready();
                window.Telegram.WebApp.expand();

                const initData = Telegram.WebApp.initDataUnsafe;
                topicKey = initData?.start_param;
                debugInfo = {
                    initData: initData,
                    chat: initData?.chat,
                    chatType: initData?.chat?.type,
                    chatUsername: initData?.chat?.username,
                    startParam: topicKey
                };

                // Temporary authorization: Allow if start_param is present
                if (topicKey) {
                    isAuthorized = true;
                    if (initData?.chat?.type !== "channel") {
                        debugInfo.warning = `Launched with start_param but not from a channel. chatType: ${initData?.chat?.type || 'none'}`;
                    }
                } else {
                    debugInfo.error = "No start_param provided.";
                }

                Telegram.WebApp.setBackgroundColor('#1e1e2d');
                Telegram.WebApp.setHeaderColor('#1e1e2d');
            }

            // Fallback for browser testing
            if (!topicKey) {
                const urlParams = new URLSearchParams(window.location.search);
                topicKey = urlParams.get("startapp");
                debugInfo.urlParams = topicKey;
                if (DEBUG_MODE) isAuthorized = true; // Allow testing in browser
            }

            updateContent(topicKey, isAuthorized, debugInfo);
        });
    </script>
</body>
</html>
